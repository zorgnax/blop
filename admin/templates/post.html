[% title = post ? "Edit " _ post.label2 : "Add Post" %]
[% PROCESS header.html x1="Publish" x2="Post" %]

<form id="post" name="post" method="post" class="aform">

<input type="hidden" id="postid" name="postid" value="[% post.postid %]"/>
<input type="hidden" name="csrf" value="[% blop.csrf %]"/>

<div class="aentry">
<label for="title">Title</label><br/>
<input id="title" name="title" type="text" value="[% post.title | html %]"/><span class="title-error aform-error"></span>
</div>

<div class="aentry">
<label for="url">Url <span class="input-info">Autogenerated if empty.</span></label><br/>
<input id="url" name="url" type="text" value="[% post.url | html %]"/><span class="url-error aform-error"></span>
</div>

<div class="aentry">
[% PROCESS editor.html entry=post %]
</div>

<div class="aentry">
<input type="submit" value="Post"/>
<span class="aform-mesg aform-error"></span>
</div>

<div class="aentry">
[% PROCESS upload.html entry=post %]
</div>

<div class="aentry">
<label for="published">Publish Date <span class="input-info">YYYY-MM-DD or leave empty to publish immediately.</span></label><br/>
<input id="published" name="published" type="text" value="[% post.published | html %]"/><span class="published-error aform-error"></span>
</div>

<div class="aentry">
<label for="category">Category</label><br/>
<input id="category" name="category" type="text" value="[% post.category.name | html %]"/><span class="category-error aform-error"></span>
</div>

<div class="aentry">
<label for="tags">Tags</label><br/>
<input id="tags" name="tags" type="text" value="[% post.tags_str | html %]"/><span class="tags-error aform-error"></span>
</div>

<div class="aentry">
<input type="submit" value="Post"/>
[% IF post %]
<input type="button" id="delete" value="Delete"/>
[% END %]
<input type="button" id="cancel" value="Cancel"/>
</div>

</form>

[% IF post %]<br/><a href="[% post.fullurl %]">View the post</a>[% END %]

<script type="text/javascript" src="[% urlbase %]/admin/js/aform.js"></script>
<script type="text/javascript" src="[% urlbase %]/admin/js/url-filler.js"></script>
<script type="text/javascript" src="[% urlbase %]/admin/js/editor.js"></script>
<script type="text/javascript" src="[% urlbase %]/admin/js/upload.js"></script>
<script type="text/javascript">
var aform = new AForm({
    formId: "#post", processUrl: "[% urlbase %]/admin/post-js"});
aform.onSuccess = function (data) {
    [% IF post %]
    location.href = "[% urlbase %]/admin/post-edited/" + data.postid;
    [% ELSE %]
    location.href = "[% urlbase %]/admin/post-added/" + data.postid;
    [% END %]
}

var urlFiller = new URLFiller({
    fromInputId: "#title", urlInputId: "#url"});

var editor = new Editor({divId: "#editor"});

var upload = new Upload({
    divId: "#upload",
    csrf: "[% blop.csrf %]",
    processUrl: "[% urlbase %]/admin/upload-js",
    deleteUrl: "[% urlbase %]/admin/delete-file-js",
    editor: editor
});
upload.extraParams = function () {
    return {postid: $("#postid").val()};
}
upload.onSuccess = function (data) {
    $("#postid").val(data.postid);
}

$("#delete").on("click", function () {
    var postid = $("#postid").val();
    if (!postid) {
        location.href = "[% urlbase %]/admin";
        return;
    }
    var ajax = $.ajax({
        url: "[% urlbase %]/admin/delete-post-js",
        type: "POST",
        data: {postid: postid, csrf: "[% blop.csrf %]"}
    });
    ajax.done(function (data, textStatus, jqXHR) {
        if (data.error) {
            $("#post .aform-mesg").text(data.mesg ? data.mesg : "Okay!");
            return;
        }
        location.href = "[% urlbase %]/admin";
    });
    ajax.fail(function (jqXHR, textStatus, errorThrown) {
        $("#post .aform-mesg").text(errorThrown);
    });
});

$("#cancel").on("click", function () {
    location.href = "[% urlbase %]/admin";
});
</script>

[% PROCESS footer.html %]


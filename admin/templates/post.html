[% title = post ? "Edit Post " _ post.postid : "Add Post" %]
[% PROCESS header.html x1="Publish" x2="Post" %]

<form id="post" name="post" method="post" class="aform">

<input type="hidden" id="postid" name="postid" value="[% post.postid %]"/>

<label for="title">Title</label>
<input id="title" name="title" type="text" value="[% post.title | html %]"/><span id="title-error" class="aform-error"></span>

<label for="url">Url <span class="input-info">Autogenerated if empty.</span></label>
<input id="url" name="url" type="text" value="[% post.url | html %]"/><span id="url-error" class="aform-error"></span>

<br/><br/>

[% PROCESS editor.html entry=post %]

<input type="submit" value="Post"/>
<span id="post-mesg" class="aform-error"></span>

[% PROCESS upload.html entry=post %]

<label for="published">Publish Date <span class="input-info">YYYY-MM-DD or leave empty to publish immediately.</span></label>
<input id="published" name="published" type="text" value="[% post.published | html %]"/><span id="published-error" class="aform-error"></span>

<label for="category">Category</label>
<input id="category" name="category" type="text" value="[% post.category.name | html %]"/><span id="category-error" class="aform-error"></span>

<label for="tags">Tags</label>
<input id="tags" name="tags" type="text" value="[% post.tags_str | html %]"/><span id="tags-error" class="aform-error"></span>

<br/>

<input type="submit" value="Post"/>

<hr/>

<input type="button" id="delete" value="[% IF post %]Delete[% ELSE %]Cancel[% END %]"/>
</form>

<script type="text/javascript" src="[% urlbase %]/admin/js/aform.js"></script>
<script type="text/javascript" src="[% urlbase %]/admin/js/url-filler.js"></script>
<script type="text/javascript" src="[% urlbase %]/admin/js/editor.js"></script>
<script type="text/javascript" src="[% urlbase %]/admin/js/upload.js"></script>
<script type="text/javascript">
var aform = new AForm({
    formId: "#post", processUrl: "[% urlbase %]/admin/post-js"});
aform.onSuccess = function (data) {
    [% IF post %]
    location.href = "[% urlbase %]/admin/post-edited/" + data.postid;
    [% ELSE %]
    location.href = "[% urlbase %]/admin/post-added/" + data.postid;
    [% END %]
}

var urlFiller = new URLFiller({
    fromInputId: "#title", urlInputId: "#url", prepend: "post/"});

var editor = new Editor({divId: "#editor"});

var upload = new Upload({
    divId: "#upload",
    processUrl: "[% urlbase %]/admin/upload-js",
    deleteUrl: "[% urlbase %]/admin/delete-file-js",
    editor: editor
});
upload.extraParams = function () {
    return {postid: $("#postid").val()};
}
upload.onSuccess = function (data) {
    $("#postid").val(data.postid);
}

$("#delete").on("click", function () {
    var postid = $("#postid").val();
    if (!postid) {
        location.href = "[% urlbase %]/admin";
        return;
    }
    var ajax = $.ajax({
        url: "[% urlbase %]/admin/delete-post-js",
        type: "POST",
        data: {postid: postid}
    });
    ajax.done(function (data, textStatus, jqXHR) {
        if (data.error) {
            $("#post-mesg").text(data.mesg ? data.mesg : "Okay!");
            return;
        }
        location.href = "[% urlbase %]/admin";
    });
    ajax.fail(function (jqXHR, textStatus, errorThrown) {
        $("#post-mesg").text(errorThrown);
    });
});
</script>

[% PROCESS footer.html %]

